name: Windows VC2022 IfcImportPlugin Complete

on:
  # run nightly at 4:00 am
#  schedule:
#    - cron: "0 4 * * *"
  # allow to be triggered on github webpage manually
  workflow_dispatch:
  # run whenever someone pushes data
  # WARNING: this may give excessive build times which need to be paid!
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    
    
env:
  QT_VERSION: qt6
  QT_DETAILED_VERSION: '6.9.3'
  VC_VERSION: '2022'

jobs:
  build:

    runs-on: windows-latest

    steps:
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: install jom
      run: choco install jom -y

    - name: Install aqtinstall
      run: python -m pip install --upgrade aqtinstall

    - name: Install Qt ${{ env.QT_DETAILED_VERSION }} on Windows
      shell: pwsh
      run: |
        # Force remove previous Qt folder if it exists
        if (Test-Path "qt") {
            Write-Host "Removing existing qt folder..."
            Remove-Item -Recurse -Force "qt" -ErrorAction SilentlyContinue
        }
    
        # Install Qt
        python -m aqt install-qt windows desktop ${{ env.QT_DETAILED_VERSION }} win64_msvc${{ env.VC_VERSION }}_64 `
            --archives qtbase qtsvg qtdeclarative `
            --modules qtpositioning `
            --outputdir qt
    
        # Set Qt bin to PATH
        $qt_bin = "$PWD\qt\${{ env.QT_DETAILED_VERSION }}\msvc${{ env.VC_VERSION }}_64\bin"
        echo "PATH=$qt_bin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
    
        # Set Qt6_DIR for CMake
        $qt_cmake = "$PWD\qt\${{ env.QT_DETAILED_VERSION }}\msvc${{ env.VC_VERSION }}_64\lib\cmake\Qt6"
        echo "Qt6_DIR=$qt_cmake" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
    
        # Set CMAKE_PREFIX_PATH for multi-module safety
        $qt_root = "$PWD\qt\${{ env.QT_DETAILED_VERSION }}\msvc${{ env.VC_VERSION }}_64"
        echo "CMAKE_PREFIX_PATH=$qt_root" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.SUBMODULE_PAT }}
        submodules: 'true'
        
    - name: create symlinks of submodules
      working-directory: externals
      shell: cmd
      run: createWindowsSoftlinks.bat

    - name: download highs-lib
      working-directory: externals/HiGHS
      shell: cmd
      run: download-highs_VC19_x64.bat

    - name: build
      working-directory: build/cmake/
      shell: cmd
      run: build_VC_x64.bat release
      
    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v4
      with:
        name: IfcImportPlugin_win64
        path: bin\release_x64\*.dll
